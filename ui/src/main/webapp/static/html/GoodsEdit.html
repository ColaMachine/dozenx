<div class="ibox float-e-margins">
    <form id="goodsEditForm" class="form-horizontal" method="post" action="/goods/save.json" enctype="multipart/form-data">
        <!--<div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title">商品编辑</h4>
        </div>-->
        <div class="ibox-content">
            <div class="form-group">
                <label for="id" class="col-sm-2 control-label">编号:</label>
                <div class="col-sm-10">
                    <input type="number" id="id" name="id"  class="form-control input-sm"  maxlength="9" onkeyup="chkInt(this,8)" onafterpaste="chkInt(this,8)"></input>
                </div>
            </div>
            <div class="form-group">
                <label for="shopId" class="col-sm-2 control-label">商户id:</label>
                <div class="col-sm-10">
                    <input type="number" id="shopId" name="shopId"  class="form-control input-sm"  maxlength="9" onkeyup="chkInt(this,8)" onafterpaste="chkInt(this,8)"></input>
                </div>
            </div>
            <div class="form-group">
                <label for="name" class="col-sm-2 control-label">名称:</label>
                <div class="col-sm-10">
                    <input  type="text"  id="name" name="name"  class="form-control input-sm"   maxlength="50"  ></input>
                </div>
            </div>
            <div class="form-group">
                <label for="subName" class="col-sm-2 control-label">副标题:</label>
                <div class="col-sm-10">
                    <input  type="text"  id="subName" name="subName"  class="form-control input-sm"   maxlength="50"  ></input>
                </div>
            </div>
            <div class="form-group">
                <label for="detail" class="col-sm-2 control-label">详细内容:</label>
                <div class="col-sm-10">
                    <script id="editor" type="text/plain" style="width:1024px;height:500px;"></script>            <textarea  id="detail" name="detail"  class="form-control input-sm"   maxlength="50000" style="display:none" ></textarea>
                </div>
            </div>
            <div class="form-group">
                <label for="address" class="col-sm-2 control-label">地址:</label>
                <div class="col-sm-10">
                    <textarea  id="address" name="address"  class="form-control input-sm"   maxlength="200"  ></textarea>
                </div>
            </div>
            <div class="form-group">
                <label for="telno" class="col-sm-2 control-label">手机号码:</label>
                <div class="col-sm-10">
                    <input  type="text"  id="telno" name="telno"  class="form-control input-sm"   maxlength="11"  ></input>
                </div>
            </div>
            <div class="form-group">
                <label for="img" class="col-sm-2 control-label">图片0:</label>
                <div class="col-sm-10">
                    <input  id="img" name="img"  value="null" style="display:none" class="form-control input-sm"   maxlength="100"></input>        </div>
            </div>
            <div class="form-group">
                <label for="img1" class="col-sm-2 control-label">图片1:</label>
                <div class="col-sm-10">
                    <input  id="img1" name="img1"  value="null" style="display:none" class="form-control input-sm"   maxlength="100"></input>        </div>
            </div>
            <div class="form-group">
                <label for="img2" class="col-sm-2 control-label">图片2:</label>
                <div class="col-sm-10">
                    <input  id="img2" name="img2"  value="null" style="display:none" class="form-control input-sm"   maxlength="100"></input>        </div>
            </div>
            <div class="form-group">
                <label for="img3" class="col-sm-2 control-label">图片3:</label>
                <div class="col-sm-10">
                    <input  id="img3" name="img3"  value="null" style="display:none" class="form-control input-sm"   maxlength="100"></input>        </div>
                <div id="multiUpload">
                    </div>
            </div>
            <div class="form-group">
                <label for="remark" class="col-sm-2 control-label">备注:</label>
                <div class="col-sm-10">
                    <textarea  id="remark" name="remark"  class="form-control input-sm"   maxlength="200"  ></textarea>
                </div>
            </div>
            <div class="form-group">
                <label for="status" class="col-sm-2 control-label">状态:</label>
                <div class="col-sm-10">
                    <select  id="status" name="status"  class="form-control input-sm"  >
                        <option value=''>-请选择-</option>
                        <option value=1>正常</option>
                        <option value=2>禁用</option>
                        <option value=3>未激活</option>
                        <option value=9>删除</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="price" class="col-sm-2 control-label">价格:</label>
                <div class="col-sm-10">
                    <input type="number" id="price" name="price"  class="form-control input-sm"  maxlength="11" onkeyup="chkInt(this,8)" onafterpaste="chkInt(this,8)"></input>
                </div>
            </div>
            <div class="form-group">
                <label for="tags" class="col-sm-2 control-label">标签:</label>
                <div class="col-sm-10">
                    <textarea  id="tags" name="tags"  class="form-control input-sm"   maxlength="100"  ></textarea>
                </div>
            </div>
            <div class="form-group">
                <label for="priceDesc" class="col-sm-2 control-label">价格描述:</label>
                <div class="col-sm-10">
                    <input  type="text"  id="priceDesc" name="priceDesc"  class="form-control input-sm"   maxlength="50"  ></input>
                </div>
            </div>
            <div class="form-group">
                <label for="creator" class="col-sm-2 control-label">创建人id:</label>
                <div class="col-sm-10">
                    <input type="number" id="creator" name="creator"  class="form-control input-sm"  maxlength="11" onkeyup="chkInt(this,8)" onafterpaste="chkInt(this,8)"></input>
                </div>
            </div>
            <div class="form-group">
                <label for="creatorName" class="col-sm-2 control-label">创建人姓名:</label>
                <div class="col-sm-10">
                    <input  type="text"  id="creatorName" name="creatorName"  class="form-control input-sm"   maxlength="50"  ></input>
                </div>
            </div>
            <div class="form-group">
                <label for="platform" class="col-sm-2 control-label">平台名称:</label>
                <div class="col-sm-10">
                    <input  type="text"  id="platform" name="platform"  class="form-control input-sm"   maxlength="50"  ></input>
                </div>
            </div>
            <div class="form-group">
                <label for="comments" class="col-sm-2 control-label">评论数:</label>
                <div class="col-sm-10">
                    <input type="number" id="comments" name="comments"  class="form-control input-sm"  maxlength="11" onkeyup="chkInt(this,8)" onafterpaste="chkInt(this,8)"></input>
                </div>
            </div>
            <div class="form-group">
                <label for="score" class="col-sm-2 control-label">分数:</label>
                <div class="col-sm-10">
                    <input type="number" id="score" name="score"  class="form-control input-sm"  onkeyup="chkFloat(this,6,3)" onafterpaste="chkFloat(this,6,3)"></input>
                </div>
            </div>
            <div class="form-group">
                <label for="link" class="col-sm-2 control-label">外链:</label>
                <div class="col-sm-10">
                    <textarea  id="link" name="link"  class="form-control input-sm"   maxlength="100"  ></textarea>
                </div>
            </div>
            <div class="form-group">
                <label for="up" class="col-sm-2 control-label">顶:</label>
                <div class="col-sm-10">
                    <input type="number" id="up" name="up"  class="form-control input-sm"  maxlength="11" onkeyup="chkInt(this,8)" onafterpaste="chkInt(this,8)"></input>
                </div>
            </div>
            <div class="form-group">
                <label for="down" class="col-sm-2 control-label">踩:</label>
                <div class="col-sm-10">
                    <input type="number" id="down" name="down"  class="form-control input-sm"  maxlength="11" onkeyup="chkInt(this,8)" onafterpaste="chkInt(this,8)"></input>
                </div>
            </div>
            <div style="display:none" class="form-group">
                <label for="createTime" class="col-sm-2 control-label">创建时间:</label>
                <div class="input-group date">
                    <span class="input-group-addon" for="createTime" ><i class="fa fa-calendar"></i></span>            <input type="text" id="createTime" name="createTime"  class="form-control input-sm"  onClick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'})"  datatype="date" format="yyyy-MM-dd HH:mm:ss"  ></input>
                </div>
            </div>
            <div style="display:none" class="form-group">
                <label for="updateTime" class="col-sm-2 control-label">更新时间:</label>
                <div class="input-group date">
                    <span class="input-group-addon" for="updateTime" ><i class="fa fa-calendar"></i></span>            <input type="text" id="updateTime" name="updateTime"  class="form-control input-sm"  onClick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'})"  datatype="date" format="yyyy-MM-dd HH:mm:ss"  ></input>
                </div>
            </div>

            <div class="hr-line-dashed"></div>
            <div class="form-group">
                <div class="col-sm-4 col-sm-offset-2">
                    <button type="button"  class="btn btn-primary saveBtn">保存</button>
                    <button type="button" class="btn btn-white cancelBtn">取消</button>
                </div>
            </div>
        </div>

    </form>
</div><!-- /.modal-content -->

<script type="text/javascript">



var goodsEdit={
    form:null,
    modal:false,
    windowIndex:null,
    formId:"#goodsEditForm",
       ue:null,
    validParam:{
        rules: {
                   id:{
            digits:true
        },
        shopId:{
            digits:true
        },
        name:{
            maxlength:50,required:true
        },
        subName:{
            maxlength:50,required:true
        },
        detail:{
            maxlength:50000,required:true
        },
        address:{
            maxlength:200
        },
        telno:{
            maxlength:11,phone:true
        },
        img:{
            maxlength:100,required:true
        },
        img1:{
            maxlength:100
        },
        img2:{
            maxlength:100
        },
        img3:{
            maxlength:100
        },
        remark:{
            maxlength:200
        },
        status:{
            CheckBox:["1","2","3","9"],digits:true,required:true
        },
        price:{
            digits:true
        },
        tags:{
            maxlength:100
        },
        priceDesc:{
            maxlength:50
        },
        creator:{
            digits:true
        },
        creatorName:{
            maxlength:50
        },
        platform:{
            maxlength:50
        },
        comments:{
            digits:true
        },
        score:{
            number:true
        },
        link:{
            maxlength:100
        },
        up:{
            digits:true
        },
        down:{
            digits:true
        },
        createTime:{
            ymd:"yyyy-MM-dd HH:mm:ss"
        },
        updateTime:{
            ymd:"yyyy-MM-dd HH:mm:ss"
        },

        },
        messages:{
                   id:{
            digits:"必须输入整数"
        },
        shopId:{
            digits:"必须输入整数"
        },
        name:{
            maxlength:"名称不能多于50个字符"
        },
        subName:{
            maxlength:"副标题不能多于50个字符"
        },
        detail:{
            maxlength:"详细内容不能多于50000个字符"
        },
        address:{
            maxlength:"地址不能多于200个字符"
        },
        telno:{
            maxlength:"手机号码不能多于11个字符"
        },
        img:{
            maxlength:"图片0不能多于100个字符"
        },
        img1:{
            maxlength:"图片1不能多于100个字符"
        },
        img2:{
            maxlength:"图片2不能多于100个字符"
        },
        img3:{
            maxlength:"图片3不能多于100个字符"
        },
        remark:{
            maxlength:"备注不能多于200个字符"
        },
        status:{
            CheckBox:"必须输入'1','2','3','9'中的值",digits:"必须输入整数"
        },
        price:{
            digits:"必须输入整数"
        },
        tags:{
            maxlength:"标签不能多于100个字符"
        },
        priceDesc:{
            maxlength:"价格描述不能多于50个字符"
        },
        creator:{
            digits:"必须输入整数"
        },
        creatorName:{
            maxlength:"创建人姓名不能多于50个字符"
        },
        platform:{
            maxlength:"平台名称不能多于50个字符"
        },
        comments:{
            digits:"必须输入整数"
        },
        score:{
            number:"必须输入合法的数字（负数，小数）"
        },
        link:{
            maxlength:"外链不能多于100个字符"
        },
        up:{
            digits:"必须输入整数"
        },
        down:{
            digits:"必须输入整数"
        },
        createTime:{
            ymd:"必须输入合法日期"
        },
        updateTime:{
            ymd:"必须输入合法日期"
        },

        }
    },
    addEventListener:function(){
        this.form.find(".saveBtn").click(this.saveInfo.Apply(this));
        this.form.find(".cancelBtn").click(this.cancel.Apply(this));
    },
    init:function(){
        this.windowIndex=dialog.windowIndex;
        this.form=$(this.formId);
        this.addEventListener();
        $("#goodsEditForm").validate(this.validParam);



        var that =this;

        UE.delEditor('editor');
        this.ue=UE.getEditor('editor');
        this.ue.addListener("ready", function () {
            that.loadData();
        });
        this.wrap=$$("#multiUpload");
        this.MultiImg();

    },
  imgList :[],
     deletePic: function() {
        this.nowDeleteImg.remove();
      },

      uploadSucc: function(result) {
        this.addImgDiv(this.wrap,null);

      },
    loadData:function(){console.log("loadData");
        var that =this;
        Ajax.getJSON(PATH+"/goods/view.json?id="+getParam("id"),null,function(data){
        console.log(data);
            if(data.r==AJAX_SUCC){
                if(data.data){
                    fillJso2Form("#goodsEditForm",data.data);
                    that.ue.setContent(data.data.detail);
                  //  $("#img3").parent().find("img").attr("src",$("#img3").val());

                     var imageUtil=new zImageUtil5({"input":"img"});
        var imageUtil=new zImageUtil5({"input":"img1"});
        var imageUtil=new zImageUtil5({"input":"img2"});

                }
            }else{
                dialog.error("获取信息失败"+data.msg,function(index){
                    goPage("goods/list.htm");
                    dialog.close(index);
                });
            }
        });
    },
    addImgDiv:function(wrap,url){
         var div =document.createElement("span");
            var input =document.createElement("input");

            input.type="hidden";
            input.value=url;
            input.name="multi_upload_input";
            input.style.display="none";
            div.appendChild(input);

           var button =document.createElement("button");
           button.innerText="删除";
           button.style.fontSize="10px";
           button.style.lineHeight="15px";
           button.type="button";
           var that =this;
            button.onclick=function(){
                that.nowDeleteImg=div;
                div.parentNode.removeChild(div);

            }
            div.appendChild(button);
            wrap.appendChild(div);
            var imageUtil = zImageUtil5({"input":input, callback: this.uploadSucc.Apply(this),});


    },
    MultiImg:function(){
        if(getParam("id")){

            Ajax.getJSON(PATH+"/pubimage/belong/list.json",{"pid":getParam("id"),"pageSize":10,"curPage":1},function(result){
                this.imgList= result.data;
                 for(var i=0;i<this.imgList.length;i++){
                    this.addImgDiv(this.wrap,this.imgList[i].url);

                }
                this.addImgDiv(this.wrap,null);
            }.Apply(this));


        }else{
            this.addImgDiv(this.wrap,null);
        }


    },
    saveInfo:function(){
    var that =this;
        $("#detail").val(this.ue.getContent());
        if (!$("#goodsEditForm").valid())
            return;
        var jso = changeForm2Jso("#goodsEditForm");
        var dialogId=dialog.showWait();
        var that=this;

        //获取多图

        //
        var multi_upload_input_list = document.getElementsByName("multi_upload_input");
        var imageUrls =[];
        for(var i=0;i<multi_upload_input_list.length;i++){
            imageUrls.push(multi_upload_input_list[i].value);

        }
        jso.imageUrls=imageUrls.join(",");
        Ajax.post(PATH+$("#goodsEditForm").attr("action"),jso,function(data){
            dialog.hideWait(dialogId);
            if(data.r==0){
                dialog.alert(data.msg||"保存成功",function(index){
                    //goPage("goods/list.htm");

                    if(that.modal){
                        $("#GoodsGrid").jqGrid("reloadGrid");
                    }
                    dialog.close(index);
                     that.cancel();
                });
            }else{
                dialog.error(data.msg);
            }
        },'json');
    },
    cancel:function(){
        if(this.modal){
           // $("#mymodal").modal("toggle");
            dialog.closeWindow(this.windowIndex);
        }else{
            goPage("goods/list.htm");
        }
    }
}
$(document).ready(function() {
    //获取传入参数
    goodsEdit.init();

});
</script>
